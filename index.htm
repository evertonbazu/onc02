<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONC - PARTE 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0c0a1a;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 20px 20px;
            touch-action: manipulation;
            overflow-y: auto;
        }
        .main-container {
            background: linear-gradient(170deg, #1e1b4b 0%, #0c0a1a 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .option-button {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s;
            border-bottom-width: 4px;
        }
        .option-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .option-button:active {
            transform: translateY(-1px);
        }
        #feedback {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .screen {
            min-height: 100vh;
            width: 100%;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .video-container { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            max-width: 100%; 
            background: #000; 
            border-radius: 1rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        .video-container iframe { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="main-container">

    <!-- Tela de Login / Cadastro -->
    <div id="login-screen" class="screen">
        <div class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl max-w-md w-full text-center text-white">
            <div id="login-form">
                <h1 class="text-3xl sm:text-4xl font-bold text-violet-300">Acessar Jogo</h1>
                <p class="text-violet-200 mt-4">Digite seu cÃ³digo e senha para entrar.</p>
                <input type="text" id="login-code" placeholder="Seu cÃ³digo" class="mt-8 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <input type="password" id="login-password" placeholder="Sua senha" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <button id="login-button" class="mt-6 w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-2xl font-bold py-3 rounded-xl shadow-lg hover:shadow-purple-500/50 transition flex items-center justify-center option-button border-purple-700">
                    <span class="button-text">Entrar</span>
                    <div class="loader hidden ml-3"></div>
                </button>
                <p id="login-message" class="text-red-400 mt-4 h-5"></p>
                <div class="flex space-x-2 mt-2">
                    <button id="go-to-register" class="w-1/2 text-violet-300 hover:underline">NÃ£o tenho cadastro</button>
                    <button id="view-ranking-button" class="w-1/2 text-violet-300 hover:underline">Ver Ranking</button>
                </div>
            </div>
            <div id="register-form" class="hidden">
                <h1 class="text-3xl sm:text-4xl font-bold text-violet-300">Criar Cadastro</h1>
                <p class="text-violet-200 mt-4">Preencha seus dados para criar um acesso.</p>
                <input type="text" id="register-name" placeholder="Nome Completo" class="mt-8 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <select id="register-class" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                    <option value="" class="text-black">Selecione sua turma</option>
                    <option value="5Âº Ano A" class="text-black">5Âº Ano A</option>
                    <option value="5Âº Ano B" class="text-black">5Âº Ano B</option>
                </select>
                <input type="text" id="register-code" placeholder="Crie um cÃ³digo de acesso" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <input type="password" id="register-password" placeholder="Crie uma senha" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <button id="register-button" class="mt-6 w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white text-2xl font-bold py-3 rounded-xl shadow-lg hover:shadow-green-500/50 transition flex items-center justify-center option-button border-green-700">
                    <span class="button-text">Cadastrar e Entrar</span>
                    <div class="loader hidden ml-3"></div>
                </button>
                <p id="register-message" class="text-red-400 mt-4 h-5"></p>
                <button id="back-to-login" class="mt-2 text-violet-300 hover:underline">JÃ¡ tenho cadastro</button>
            </div>
        </div>
    </div>

    <!-- Tela do VÃ­deo -->
    <div id="video-screen" class="screen hidden">
        <div class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl max-w-3xl w-full text-center text-white">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-violet-300">Vamos aprender!</h2>
            <p class="text-base sm:text-lg text-violet-200 mt-2 mb-4">Assista ao vÃ­deo para revisar e ganhar atÃ© 1000 pontos!</p>
            <div class="mb-4 bg-white/10 rounded-full px-6 py-2 inline-block">
                <span class="text-2xl font-semibold text-violet-200">Pontos: <span class="score-display">0</span></span>
            </div>
            <div class="video-container">
                <div id="player"></div>
            </div>
            <button id="continue-btn" class="mt-8 w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white text-2xl sm:text-3xl font-bold py-3 sm:py-4 rounded-xl shadow-lg transition transform hover:shadow-green-500/50 opacity-50 cursor-not-allowed option-button border-green-700" disabled>
                Ir para o Jogo!
            </button>
            <button id="skip-video-btn" class="mt-2 text-gray-400 hover:text-gray-200 hover:underline">Pular vÃ­deo (nÃ£o ganha pontos)</button>
        </div>
    </div>

    <!-- Tela do Jogo (Quiz) -->
    <div id="game-screen" class="screen hidden">
        <div class="w-full max-w-4xl">
             <header class="text-center mb-4 sm:mb-8 w-full">
                 <div class="flex justify-center items-center w-full">
                     <div class="glass-card rounded-full px-4 sm:px-6 py-2">
                         <span class="text-xl sm:text-2xl font-semibold text-violet-200">Pontos: <span class="score-display">0</span></span>
                     </div>
                 </div>
                 <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mt-4" style="text-shadow: 0 0 15px rgba(167, 139, 250, 0.7);">
                     ONC - PARTE 2
                 </h1>
                  <p class="text-lg sm:text-xl text-violet-300 mt-2">OlÃ¡, <span id="player-firstname"></span>! Escolha a resposta certa.</p>
             </header>
            <main class="w-full glass-card p-6 sm:p-8 rounded-2xl shadow-xl text-center">
                <div id="question-container" class="mb-6 sm:mb-8 text-xl sm:text-2xl md:text-3xl font-semibold text-white min-h-[6rem] flex items-center justify-center">
                    <!-- A pergunta aparecerÃ¡ aqui -->
                </div>
                <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <!-- As opÃ§Ãµes aparecerÃ£o aqui -->
                </div>
            </main>
        </div>
    </div>

    <!-- Tela Final (Game Over) -->
    <div id="end-screen" class="screen hidden">
        <div class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl max-w-3xl w-full text-center my-8 text-white">
            <div id="end-screen-content">
                <h1 class="text-3xl sm:text-4xl font-bold text-violet-300">Fim de Jogo!</h1>
                <p id="final-message" class="text-lg text-violet-200 mt-4 font-semibold"></p>
                <p id="bonus-message" class="text-lg text-green-400 mt-2 font-semibold"></p>
                <div class="flex justify-center items-center my-6 text-violet-200">
                    <div class="text-xl"><strong>Pontos:</strong> <span id="final-score">0</span></div>
                </div>
            </div>
            <h2 class="text-2xl sm:text-3xl font-bold text-violet-300 mt-6 mb-4">Ranking (Top 100)</h2>
            <div class="overflow-y-auto h-64 bg-white/5 rounded-lg">
                <table class="w-full text-left">
                    <thead class="bg-white/10 sticky top-0">
                        <tr>
                            <th class="p-2">#</th>
                            <th class="p-2">Nome</th>
                            <th class="p-2">Pontos</th>
                            <th class="p-2">Turma</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <tr><td colspan="4" class="p-8 text-center"><div class="loader mx-auto"></div></td></tr>
                    </tbody>
                </table>
            </div>
            <button id="play-again-button" class="mt-8 w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white text-2xl sm:text-3xl font-bold py-3 rounded-xl shadow-lg hover:shadow-yellow-500/50 transition option-button border-yellow-700">
                Jogar Novamente
            </button>
            <button id="back-from-ranking-button" class="mt-8 w-full bg-gray-500 text-white text-2xl sm:text-3xl font-bold py-3 rounded-xl shadow-lg hover:bg-gray-600 transition hidden option-button border-gray-700">
                Voltar
            </button>
        </div>
    </div>

    <div id="feedback" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 sm:p-8 rounded-2xl text-white text-2xl font-bold shadow-2xl opacity-0 pointer-events-none w-11/12 max-w-sm text-center"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvzdtou17UCu8lmOFg9fxVEaLg1FnWcvexCYUZzqNLcUhiE6mZW_OkxeeI874AXZRT/exec';
        const NOME_DESTE_JOGO = "ONC - PARTE 2";

        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen');
        const videoScreen = document.getElementById('video-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const continueBtn = document.getElementById('continue-btn');
        const skipVideoBtn = document.getElementById('skip-video-btn');
        const loginForm = document.getElementById('login-form');
        const loginCodeInput = document.getElementById('login-code');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginMessage = document.getElementById('login-message');
        const goToRegisterButton = document.getElementById('go-to-register');
        const registerForm = document.getElementById('register-form');
        const registerNameInput = document.getElementById('register-name');
        const registerClassInput = document.getElementById('register-class');
        const registerCodeInput = document.getElementById('register-code');
        const registerPasswordInput = document.getElementById('register-password');
        const registerButton = document.getElementById('register-button');
        const registerMessage = document.getElementById('register-message');
        const backToLoginButton = document.getElementById('back-to-login');
        const playerFirstNameEl = document.getElementById('player-firstname');
        const finalMessageEl = document.getElementById('final-message');
        const viewRankingButton = document.getElementById('view-ranking-button');
        const backFromRankingButton = document.getElementById('back-from-ranking-button');
        const playAgainButton = document.getElementById('play-again-button');
        const endScreenContent = document.getElementById('end-screen-content');
        const questionContainer = document.getElementById('question-container');
        const optionsContainer = document.getElementById('options-container');
        const feedbackEl = document.getElementById('feedback');
        const bonusMessageEl = document.getElementById('bonus-message');

        // --- ESTADO DO JOGO ---
        let score = 0;
        let startTime;
        let loggedInUser = null;
        let videoPointsInvalidated = false;
        let currentQuestionIndex = 0;
        let shuffledQuestions = [];

        // --- BANCO DE PERGUNTAS COM EXPLICAÃ‡Ã•ES E PONTOS ---
        const questions = [
            // Sistema DigestÃ³rio (10 Pontos)
            { question: 'Qual Ã³rgÃ£o do sistema digestÃ³rio Ã© responsÃ¡vel por triturar os alimentos com os dentes e iniciar a digestÃ£o com a saliva?', options: ['EstÃ´mago', 'Intestino delgado', 'Boca', 'EsÃ´fago', 'FÃ­gado'], answer: 'Boca', explanation: 'A boca, com os dentes e a saliva, Ã© o primeiro local onde os alimentos sÃ£o triturados e a digestÃ£o quÃ­mica comeÃ§a.', points: 10 },
            { question: 'Qual Ã© a principal funÃ§Ã£o do esÃ´fago no processo digestÃ³rio?', options: ['Absorver nutrientes', 'Triturar os alimentos', 'Levar a comida ao estÃ´mago atravÃ©s de movimentos peristÃ¡lticos', 'Produzir Ã¡cido clorÃ­drico', 'Formar as fezes'], answer: 'Levar a comida ao estÃ´mago atravÃ©s de movimentos peristÃ¡lticos', explanation: 'O esÃ´fago Ã© um tubo muscular que usa movimentos de onda (peristaltismo) para empurrar o alimento atÃ© o estÃ´mago.', points: 10 },
            { question: 'Quando mastigamos um alimento na boca, que tipo de digestÃ£o estÃ¡ acontecendo principalmente?', options: ['DigestÃ£o quÃ­mica', 'AbsorÃ§Ã£o', 'EliminaÃ§Ã£o', 'DigestÃ£o mecÃ¢nica', 'DigestÃ£o enzimÃ¡tica'], answer: 'DigestÃ£o mecÃ¢nica', explanation: 'A mastigaÃ§Ã£o Ã© um exemplo de digestÃ£o mecÃ¢nica, onde o alimento Ã© fisicamente quebrado em pedaÃ§os menores.', points: 10 },
            { question: 'Onde ocorre a principal absorÃ§Ã£o dos nutrientes, graÃ§as Ã s vilosidades?', options: ['EstÃ´mago', 'Intestino grosso', 'EsÃ´fago', 'Intestino delgado', 'FÃ­gado'], answer: 'Intestino delgado', explanation: 'O intestino delgado possui pequenas dobras chamadas vilosidades que aumentam muito a Ã¡rea de superfÃ­cie para absorver nutrientes.', points: 10 },
            { question: 'Qual Ã³rgÃ£o produz a bile, que ajuda na digestÃ£o das gorduras?', options: ['PÃ¢ncreas', 'EstÃ´mago', 'Intestino grosso', 'FÃ­gado', 'Boca'], answer: 'FÃ­gado', explanation: 'O fÃ­gado produz a bile, uma substÃ¢ncia que ajuda a quebrar as gorduras em pequenas partÃ­culas para facilitar a digestÃ£o.', points: 10 },
            { question: 'Qual tipo de alimento leva mais tempo para ser digerido pelo corpo?', options: ['LÃ­quidos', 'Frutas', 'Verduras', 'Carnes', 'Gorduras'], answer: 'Gorduras', explanation: 'Gorduras sÃ£o os alimentos que levam mais tempo para serem digeridos, de 6 a 8 horas, pois exigem um processo mais complexo.', points: 10 },

            // Sistema RespiratÃ³rio (10 Pontos)
            { question: 'Qual a principal funÃ§Ã£o do sistema respiratÃ³rio?', options: ['Quebrar alimentos', 'Transportar sangue', 'Realizar trocas gasosas entre o corpo e o ambiente', 'Produzir hormÃ´nios', 'Eliminar fezes'], answer: 'Realizar trocas gasosas entre o corpo e o ambiente', explanation: 'O sistema respiratÃ³rio capta oxigÃªnio e elimina gÃ¡s carbÃ´nico.', points: 10 },
            { question: 'Em qual parte do sistema respiratÃ³rio estÃ£o as cordas vocais, responsÃ¡veis pela produÃ§Ã£o do som da voz?', options: ['Faringe', 'Traqueia', 'BrÃ´nquios', 'Laringe', 'AlvÃ©olos'], answer: 'Laringe', explanation: 'A laringe contÃ©m as cordas vocais, que vibram com a passagem do ar para produzir a voz.', points: 10 },
            { question: 'Onde acontecem as trocas gasosas, ou seja, a troca de oxigÃªnio por gÃ¡s carbÃ´nico nos pulmÃµes?', options: ['Traqueia', 'BrÃ´nquios', 'BronquÃ­olos', 'AlvÃ©olos', 'Faringe'], answer: 'AlvÃ©olos', explanation: 'Os alvÃ©olos sÃ£o pequenas bolsas nos pulmÃµes, com paredes muito finas, onde o oxigÃªnio entra no sangue e o gÃ¡s carbÃ´nico sai.', points: 10 },
            { question: 'O que acontece com o diafragma e os pulmÃµes durante a inspiraÃ§Ã£o?', options: ['O diafragma sobe e os pulmÃµes se contraem', 'O diafragma desce e os pulmÃµes se expandem', 'O diafragma fica parado e os pulmÃµes se contraem', 'O diafragma sobe e os pulmÃµes se expandem', 'O diafragma desce e os pulmÃµes ficam parados'], answer: 'O diafragma desce e os pulmÃµes se expandem', explanation: 'Durante a inspiraÃ§Ã£o, o diafragma se contrai e desce, o que aumenta o espaÃ§o nos pulmÃµes e permite que o ar entre.', points: 10 },
            { question: 'Qual o nome do processo de troca de oxigÃªnio por gÃ¡s carbÃ´nico que ocorre nos alvÃ©olos pulmonares?', options: ['DigestÃ£o', 'AbsorÃ§Ã£o', 'ExcreÃ§Ã£o', 'Hematose', 'CirculaÃ§Ã£o'], answer: 'Hematose', explanation: 'Hematose Ã© o nome especÃ­fico dado Ã  troca de gases (oxigÃªnio e gÃ¡s carbÃ´nico) entre os alvÃ©olos e o sangue.', points: 10 },
            { question: 'Qual a frequÃªncia respiratÃ³ria normal em uma pessoa adulta em repouso?', options: ['5 a 10 respiraÃ§Ãµes por minuto', '12 a 20 respiraÃ§Ãµes por minuto', '25 a 30 respiraÃ§Ãµes por minuto', '30 a 40 respiraÃ§Ãµes por minuto', 'Mais de 40 respiraÃ§Ãµes por minuto'], answer: '12 a 20 respiraÃ§Ãµes por minuto', explanation: 'Essa Ã© a faixa considerada normal para adultos saudÃ¡veis em repouso.', points: 10 },
            
            // RelaÃ§Ã£o RespiraÃ§Ã£o, DigestÃ£o e Energia (20 Pontos)
            { question: 'Qual a substÃ¢ncia que a digestÃ£o quebra dos carboidratos para ser usada como "combustÃ­vel" nas cÃ©lulas?', options: ['ProteÃ­na', 'Gordura', 'Glicose', 'Ãgua', 'Sais minerais'], answer: 'Glicose', explanation: 'Os carboidratos sÃ£o quebrados em glicose, que Ã© a principal fonte de energia para as cÃ©lulas do corpo.', points: 20 },
            { question: 'Para o corpo produzir energia, quais duas substÃ¢ncias principais ele combina dentro das cÃ©lulas?', options: ['Ãgua e gÃ¡s carbÃ´nico', 'ProteÃ­na e gordura', 'Glicose e oxigÃªnio', 'Sais minerais e vitaminas', 'Fibra e Ã¡gua'], answer: 'Glicose e oxigÃªnio', explanation: 'A glicose (do alimento) e o oxigÃªnio (do ar) sÃ£o combinados nas cÃ©lulas para produzir energia.', points: 20 },
            { question: 'Onde ocorre o processo de respiraÃ§Ã£o celular, que produz energia para o corpo?', options: ['Na boca', 'No estÃ´mago', 'Nas mitocÃ´ndrias das cÃ©lulas', 'Nos pulmÃµes', 'Nos rins'], answer: 'Nas mitocÃ´ndrias das cÃ©lulas', explanation: 'As mitocÃ´ndrias sÃ£o como as "usinas de energia" das cÃ©lulas, onde a glicose e o oxigÃªnio sÃ£o transformados em energia (ATP).', points: 20 },
            { question: 'AlÃ©m de energia, quais sÃ£o os outros produtos da respiraÃ§Ã£o celular que precisam ser eliminados do corpo?', options: ['ProteÃ­nas e vitaminas', 'Carboidratos e gorduras', 'GÃ¡s carbÃ´nico e Ã¡gua', 'CÃ¡lcio e ferro', 'OxigÃªnio e glicose'], answer: 'GÃ¡s carbÃ´nico e Ã¡gua', explanation: 'O gÃ¡s carbÃ´nico Ã© eliminado pelos pulmÃµes e a Ã¡gua Ã© eliminada pela urina e suor.', points: 20 },

            // Sistema CirculatÃ³rio (20 Pontos)
            { question: 'Qual a principal funÃ§Ã£o do sistema circulatÃ³rio?', options: ['Produzir alimentos para o corpo', 'Filtrar o ar que respiramos', 'Transportar sangue, nutrientes, oxigÃªnio e resÃ­duos por todo o corpo', 'Quebrar molÃ©culas grandes em pequenas', 'Formar as fezes'], answer: 'Transportar sangue, nutrientes, oxigÃªnio e resÃ­duos por todo o corpo', explanation: 'O sistema circulatÃ³rio Ã© a rede de transporte do corpo.', points: 20 },
            { question: 'Quantas cavidades tem o coraÃ§Ã£o humano?', options: ['Duas', 'TrÃªs', 'Quatro', 'Cinco', 'Seis'], answer: 'Quatro', explanation: 'O coraÃ§Ã£o humano tem dois Ã¡trios (superiores) e dois ventrÃ­culos (inferiores).', points: 20 },
            { question: 'Qual componente do sangue Ã© responsÃ¡vel por transportar o oxigÃªnio atravÃ©s da hemoglobina?', options: ['Plasma', 'GlÃ³bulos brancos', 'Plaquetas', 'GlÃ³bulos vermelhos', 'Ãgua'], answer: 'GlÃ³bulos vermelhos', explanation: 'Os glÃ³bulos vermelhos contÃªm hemoglobina, que se liga ao oxigÃªnio para transportÃ¡-lo.', points: 20 },
            { question: 'Quais vasos sanguÃ­neos levam sangue do coraÃ§Ã£o para o corpo (sangue geralmente oxigenado)?', options: ['Veias', 'Capilares', 'ArtÃ©rias', 'LinfÃ¡ticos', 'TÃºbulos'], answer: 'ArtÃ©rias', explanation: 'As artÃ©rias sÃ£o vasos que transportam sangue rico em oxigÃªnio do coraÃ§Ã£o para todas as partes do corpo.', points: 20 },
            { question: 'Onde ocorrem as trocas de substÃ¢ncias (nutrientes e gases) entre o sangue e as cÃ©lulas do corpo?', options: ['ArtÃ©rias grandes', 'Veias grandes', 'Capilares', 'CoraÃ§Ã£o', 'PulmÃµes'], answer: 'Capilares', explanation: 'Os capilares sÃ£o vasos sanguÃ­neos muito finos, onde as paredes sÃ£o tÃ£o finas que permitem a troca de oxigÃªnio, nutrientes e resÃ­duos com as cÃ©lulas.', points: 20 },
            { question: 'Qual tipo de circulaÃ§Ã£o leva o sangue do coraÃ§Ã£o para os pulmÃµes e de volta ao coraÃ§Ã£o para ser oxigenado?', options: ['CirculaÃ§Ã£o sistÃªmica', 'CirculaÃ§Ã£o dupla', 'CirculaÃ§Ã£o pulmonar', 'CirculaÃ§Ã£o portal', 'CirculaÃ§Ã£o linfÃ¡tica'], answer: 'CirculaÃ§Ã£o pulmonar', explanation: 'A circulaÃ§Ã£o pulmonar Ã© o caminho do sangue do coraÃ§Ã£o para os pulmÃµes (onde pega oxigÃªnio) e de volta ao coraÃ§Ã£o.', points: 20 },
            
            // Transporte de Nutrientes e Gases (30 Pontos)
            { question: 'Onde o oxigÃªnio se liga para ser transportado dos pulmÃµes para todas as cÃ©lulas do corpo?', options: ['No plasma', 'Nos glÃ³bulos brancos', 'Na hemoglobina dos glÃ³bulos vermelhos', 'Nas plaquetas', 'Na Ã¡gua'], answer: 'Na hemoglobina dos glÃ³bulos vermelhos', explanation: 'A hemoglobina, uma proteÃ­na presente nos glÃ³bulos vermelhos, Ã© a principal transportadora de oxigÃªnio.', points: 30 },
            { question: 'O gÃ¡s carbÃ´nico, produto da respiraÃ§Ã£o celular, Ã© transportado das cÃ©lulas para os pulmÃµes para ser eliminado atravÃ©s de qual processo?', options: ['InspiraÃ§Ã£o', 'DigestÃ£o', 'ExpiraÃ§Ã£o', 'AbsorÃ§Ã£o', 'CoagulaÃ§Ã£o'], answer: 'ExpiraÃ§Ã£o', explanation: 'O gÃ¡s carbÃ´nico Ã© um resÃ­duo da respiraÃ§Ã£o celular e Ã© eliminado do corpo quando expiramos (soltamos o ar).', points: 30 },
            { question: 'Qual mecanismo de transporte Ã© responsÃ¡vel pelo movimento de gases, como oxigÃªnio e gÃ¡s carbÃ´nico, atravÃ©s das membranas celulares, sem gastar energia?', options: ['Transporte ativo', 'Osmose', 'PressÃ£o sanguÃ­nea', 'DifusÃ£o', 'CirculaÃ§Ã£o'], answer: 'DifusÃ£o', explanation: 'A difusÃ£o Ã© o movimento de substÃ¢ncias de uma Ã¡rea de maior concentraÃ§Ã£o para uma de menor concentraÃ§Ã£o, sem gasto de energia, como acontece com o oxigÃªnio e o gÃ¡s carbÃ´nico.', points: 30 },

            // ExcreÃ§Ã£o de ResÃ­duos Celulares (30 Pontos)
            { question: 'Qual Ã³rgÃ£o Ã© o principal responsÃ¡vel por filtrar o sangue e produzir a urina, eliminando resÃ­duos como ureia?', options: ['FÃ­gado', 'PulmÃµes', 'Pele', 'Rins', 'Intestino grosso'], answer: 'Rins', explanation: 'Os rins filtram o sangue, removendo substÃ¢ncias indesejÃ¡veis e formando a urina.', points: 30 },
            { question: 'AlÃ©m de oxigenar o sangue, qual outro resÃ­duo os pulmÃµes eliminam do corpo a cada expiraÃ§Ã£o?', options: ['Ureia', 'Ãcido Ãºrico', 'GÃ¡s carbÃ´nico', 'Excesso de sais', 'Gorduras'], answer: 'GÃ¡s carbÃ´nico', explanation: 'Os pulmÃµes eliminam o gÃ¡s carbÃ´nico, que Ã© um produto da respiraÃ§Ã£o celular, a cada expiraÃ§Ã£o.', points: 30 },
            { question: 'Como a pele contribui para a eliminaÃ§Ã£o de resÃ­duos do corpo, alÃ©m de ajudar a regular a temperatura?', options: ['Produzindo bile', 'Filtrando o sangue', 'Eliminando Ã¡gua, sais e pequenas quantidades de ureia pelo suor', 'Quebrando toxinas', 'Formando fezes'], answer: 'Eliminando Ã¡gua, sais e pequenas quantidades de ureia pelo suor', explanation: 'O suor ajuda a liberar excesso de Ã¡gua, sais e algumas toxinas.', points: 30 },
            { question: 'Qual Ã³rgÃ£o Ã© responsÃ¡vel por processar toxinas e transformÃ¡-las em substÃ¢ncias menos nocivas, ajudando na desintoxicaÃ§Ã£o do corpo?', options: ['Rins', 'PulmÃµes', 'FÃ­gado', 'Pele', 'CoraÃ§Ã£o'], answer: 'FÃ­gado', explanation: 'O fÃ­gado tem um papel crucial na desintoxicaÃ§Ã£o, processando medicamentos, Ã¡lcool e outras substÃ¢ncias tÃ³xicas.', points: 30 },

            // Grupos Alimentares e FunÃ§Ãµes dos Nutrientes (30 Pontos)
            { question: 'Qual a principal funÃ§Ã£o dos carboidratos no nosso corpo?', options: ['ConstruÃ§Ã£o de mÃºsculos', 'Energia imediata para as cÃ©lulas', 'Isolamento tÃ©rmico', 'AbsorÃ§Ã£o de vitaminas lipossolÃºveis', 'FormaÃ§Ã£o de anticorpos'], answer: 'Energia imediata para as cÃ©lulas', explanation: 'Os carboidratos sÃ£o a principal e mais rÃ¡pida fonte de energia para o corpo, especialmente para o cÃ©rebro.', points: 30 },
            { question: 'Qual a principal funÃ§Ã£o das proteÃ­nas no nosso corpo?', options: ['Fornecer energia concentrada', 'Ser a principal fonte de energia para o cÃ©rebro', 'ConstruÃ§Ã£o e reparaÃ§Ã£o de tecidos, como mÃºsculos e pele', 'Regular a temperatura corporal', 'Ajudar na absorÃ§Ã£o de vitaminas A, D, E, K'], answer: 'ConstruÃ§Ã£o e reparaÃ§Ã£o de tecidos, como mÃºsculos e pele', explanation: 'As proteÃ­nas sÃ£o os "tijolos" do corpo, essenciais para crescer, reparar e manter os tecidos.', points: 30 },
            { question: 'As gorduras tÃªm diversas funÃ§Ãµes. Qual das opÃ§Ãµes abaixo NÃƒO Ã© uma funÃ§Ã£o principal das gorduras?', options: ['Energia concentrada', 'Isolamento tÃ©rmico', 'ProteÃ§Ã£o de Ã³rgÃ£os', 'AbsorÃ§Ã£o de vitaminas lipossolÃºveis', 'Ser a base para a formaÃ§Ã£o de anticorpos'], answer: 'Ser a base para a formaÃ§Ã£o de anticorpos', explanation: 'A formaÃ§Ã£o de anticorpos Ã© uma funÃ§Ã£o das proteÃ­nas, parte do sistema de defesa do corpo.', points: 30 },
            { question: 'As vitaminas sÃ£o micronutrientes importantes. Qual caracterÃ­stica NÃƒO se aplica Ã s vitaminas?', options: ['SÃ£o necessÃ¡rias em pequenas quantidades', 'SÃ£o produzidas em grandes quantidades pelo corpo', 'Devem vir da alimentaÃ§Ã£o', 'TÃªm funÃ§Ãµes reguladoras em reaÃ§Ãµes metabÃ³licas', 'Podem ser lipossolÃºveis ou hidrossolÃºveis'], answer: 'SÃ£o produzidas em grandes quantidades pelo corpo', explanation: 'A maioria das vitaminas nÃ£o Ã© produzida pelo corpo (ou Ã© produzida em quantidades insuficientes) e, por isso, precisamos obtÃª-las atravÃ©s da alimentaÃ§Ã£o.', points: 30 },
            { question: 'Qual mineral Ã© fundamental para a formaÃ§Ã£o dos ossos e dentes, alÃ©m de ser importante para a contraÃ§Ã£o muscular?', options: ['Ferro', 'SÃ³dio', 'PotÃ¡ssio', 'Zinco', 'CÃ¡lcio'], answer: 'CÃ¡lcio', explanation: 'O cÃ¡lcio Ã© o mineral mais abundante no corpo e Ã© essencial para a estrutura dos ossos e dentes, alÃ©m de ser crucial para a contraÃ§Ã£o dos mÃºsculos.', points: 30 },
            { question: 'Em termos de porcentagem das calorias totais diÃ¡rias, qual grupo de nutrientes deve ser consumido em maior quantidade?', options: ['ProteÃ­nas (10-35%)', 'Gorduras (20-35%)', 'Carboidratos (45-65%)', 'Vitaminas', 'Sais Minerais'], answer: 'Carboidratos (45-65%)', explanation: 'Os carboidratos sÃ£o a principal fonte de energia e devem compor a maior parte das calorias diÃ¡rias.', points: 30 },

            // Calorias e AlimentaÃ§Ã£o Equilibrada (40 Pontos)
            { question: 'O que sÃ£o calorias nos alimentos?', options: ['Unidades de medida do sabor', 'Unidades de medida da energia fornecida', 'Unidades de medida do peso', 'Unidades de medida da cor', 'Unidades de medida da quantidade de Ã¡gua'], answer: 'Unidades de medida da energia fornecida', explanation: 'As calorias indicam a quantidade de energia que um alimento pode fornecer ao corpo.', points: 40 },
            { question: 'Qual o principal objetivo de uma alimentaÃ§Ã£o equilibrada, alÃ©m de contar calorias?', options: ['Comer sempre a mesma coisa', 'Comer apenas um tipo de alimento', 'Considerar a qualidade e variedade dos nutrientes', 'Comer o mÃ¡ximo possÃ­vel para ter energia', 'Fazer dietas muito restritivas'], answer: 'Considerar a qualidade e variedade dos nutrientes', explanation: 'Uma alimentaÃ§Ã£o equilibrada foca em fornecer todos os nutrientes necessÃ¡rios, de diferentes grupos alimentares e com boa qualidade.', points: 40 },
            { question: 'O que determina o peso corporal de uma pessoa?', options: ['Apenas a idade', 'Apenas o sexo', 'O balanÃ§o entre calorias consumidas e calorias gastas', 'Apenas o tipo de alimento que come', 'Apenas o quanto dorme'], answer: 'O balanÃ§o entre calorias consumidas e calorias gastas', explanation: 'Se consumimos mais calorias do que gastamos, ganhamos peso; se gastamos mais do que consumimos, perdemos peso.', points: 40 },

            // AlimentaÃ§Ã£o SaudÃ¡vel e Personalizada (40 Pontos)
            { question: 'Por que nÃ£o existe uma dieta Ãºnica ideal para todas as pessoas?', options: ['Porque todas as pessoas gostam dos mesmos alimentos', 'Porque o corpo de cada pessoa tem necessidades nutricionais especÃ­ficas', 'Porque dietas personalizadas sÃ£o mais caras', 'Porque Ã© mais fÃ¡cil seguir uma dieta Ãºnica', 'Porque apenas atletas precisam de dietas especÃ­ficas'], answer: 'Porque o corpo de cada pessoa tem necessidades nutricionais especÃ­ficas', explanation: 'Fatores como idade, sexo, genÃ©tica, nÃ­vel de atividade fÃ­sica e condiÃ§Ãµes de saÃºde fazem com que as necessidades variem.', points: 40 },

            // Obesidade, DesnutriÃ§Ã£o e AlimentaÃ§Ã£o Inadequada (40 Pontos)
            { question: 'A obesidade Ã© o acÃºmulo excessivo de gordura corporal. Qual das opÃ§Ãµes abaixo NÃƒO Ã© uma consequÃªncia para a saÃºde relacionada Ã  obesidade?', options: ['DoenÃ§as cardiovasculares', 'Diabetes tipo 2', 'Problemas articulares', 'Aumento da imunidade', 'Aspectos psicolÃ³gicos negativos'], answer: 'Aumento da imunidade', explanation: 'Na verdade, a obesidade pode levar a uma diminuiÃ§Ã£o da imunidade e inflamaÃ§Ã£o crÃ´nica, nÃ£o a um aumento.', points: 40 },
            { question: 'Qual Ã© um dos sinais e consequÃªncias da desnutriÃ§Ã£o em crianÃ§as?', options: ['Crescimento adequado e peso normal para a idade', 'Aumento da energia e capacidade fÃ­sica', 'Maior susceptibilidade a infecÃ§Ãµes e crescimento inadequado', 'Melhora da concentraÃ§Ã£o e aprendizagem', 'Aumento da imunidade'], answer: 'Maior susceptibilidade a infecÃ§Ãµes e crescimento inadequado', explanation: 'A falta de nutrientes enfraquece o sistema imunolÃ³gico e impede o crescimento normal.', points: 40 },

            // HÃ¡bitos de Vida SaudÃ¡veis (40 Pontos)
            { question: 'Qual Ã© uma prÃ¡tica importante da alimentaÃ§Ã£o consciente?', options: ['Comer rapidamente sem prestar atenÃ§Ã£o', 'Pular refeiÃ§Ãµes regularmente', 'Mastigar adequadamente e comer devagar', 'Beber pouca Ã¡gua durante o dia', 'Comer sempre os mesmos alimentos'], answer: 'Mastigar adequadamente e comer devagar', explanation: 'Comer devagar e mastigar bem ajuda a perceber a saciedade e a desfrutar mais do alimento.', points: 40 },
            { question: 'Para ter um sono de qualidade, qual das aÃ§Ãµes abaixo Ã© recomendada?', options: ['Usar dispositivos eletrÃ´nicos na cama antes de dormir', 'Dormir e acordar em horÃ¡rios diferentes a cada dia', 'Manter o quarto iluminado e barulhento', 'Ter uma rotina relaxante antes de dormir', 'Dormir poucas horas para ter mais tempo'], answer: 'Ter uma rotina relaxante antes de dormir', explanation: 'Atividades como ler ou tomar um banho morno ajudam o corpo a se preparar para o sono.', points: 40 },
            { question: 'Qual estratÃ©gia ajuda na gestÃ£o do estresse?', options: ['Acumular tarefas e nÃ£o planejar o tempo', 'Isolar-se de amigos e familiares', 'Praticar tÃ©cnicas de relaxamento como respiraÃ§Ã£o profunda', 'Deixar problemas sem conversar sobre eles', 'Aumentar o consumo de cafeÃ­na'], answer: 'Praticar tÃ©cnicas de relaxamento como respiraÃ§Ã£o profunda', explanation: 'TÃ©cnicas de relaxamento ajudam a acalmar a mente e o corpo, reduzindo o estresse.', points: 40 },
            { question: 'Qual hÃ¡bito Ã© importante para a prevenÃ§Ã£o de doenÃ§as e manutenÃ§Ã£o da saÃºde?', options: ['Evitar lavar as mÃ£os', 'NÃ£o realizar exames mÃ©dicos preventivos', 'Manter o calendÃ¡rio vacinal atualizado', 'Consumir Ã¡lcool em excesso', 'NÃ£o usar protetor solar'], answer: 'Manter o calendÃ¡rio vacinal atualizado', explanation: 'A vacinaÃ§Ã£o protege contra diversas doenÃ§as infecciosas.', points: 40 },

            // ImportÃ¢ncia da Atividade FÃ­sica (40 Pontos)
            { question: 'Como a atividade fÃ­sica regular beneficia o sistema cardiovascular?', options: ['Aumenta a pressÃ£o arterial', 'Torna o coraÃ§Ã£o menos eficiente', 'Fortalece o coraÃ§Ã£o e melhora a circulaÃ§Ã£o', 'Aumenta o risco de doenÃ§as cardÃ­acas', 'Diminui o fluxo sanguÃ­neo'], answer: 'Fortalece o coraÃ§Ã£o e melhora a circulaÃ§Ã£o', explanation: 'O coraÃ§Ã£o se torna uma bomba mais forte, e a circulaÃ§Ã£o do sangue melhora.', points: 40 },
            { question: 'Qual o benefÃ­cio da atividade fÃ­sica para o sistema respiratÃ³rio?', options: ['Diminui a capacidade pulmonar', 'Piora a oxigenaÃ§Ã£o do sangue', 'Fortalece os mÃºsculos respiratÃ³rios e aumenta o volume de ar inspirado', 'Aumenta o cansaÃ§o em atividades diÃ¡rias', 'Prejudica a limpeza pulmonar'], answer: 'Fortalece os mÃºsculos respiratÃ³rios e aumenta o volume de ar inspirado', explanation: 'ExercÃ­cios tornam os pulmÃµes mais eficientes, permitindo captar mais oxigÃªnio e fortalecendo os mÃºsculos que ajudam a respirar.', points: 40 },
            { question: 'Qual o benefÃ­cio da atividade fÃ­sica para os ossos e mÃºsculos?', options: ['Diminui a densidade Ã³ssea', 'Reduz a forÃ§a muscular', 'Aumenta a resistÃªncia e forÃ§a muscular, tornando os ossos mais fortes', 'Piora a coordenaÃ§Ã£o motora', 'Aumenta o risco de lesÃµes'], answer: 'Aumenta a resistÃªncia e forÃ§a muscular, tornando os ossos mais fortes', explanation: 'O exercÃ­cio fortalece tanto os mÃºsculos quanto os ossos, tornando-os mais resistentes.', points: 40 },
            { question: 'A prÃ¡tica de exercÃ­cios fÃ­sicos tem benefÃ­cios psicolÃ³gicos importantes. Qual Ã© um deles?', options: ['Aumento do estresse', 'Piora do humor e da autoestima', 'ReduÃ§Ã£o do estresse e liberaÃ§Ã£o de hormÃ´nios do bem-estar', 'DiminuiÃ§Ã£o da memÃ³ria e concentraÃ§Ã£o', 'Piora da qualidade do sono'], answer: 'ReduÃ§Ã£o do estresse e liberaÃ§Ã£o de hormÃ´nios do bem-estar', explanation: 'O exercÃ­cio libera endorfinas, que sÃ£o hormÃ´nios que promovem a sensaÃ§Ã£o de bem-estar e reduzem o estresse.', points: 40 },

            // AvaliaÃ§Ã£o CrÃ­tica de Dietas e Rotinas (40 Pontos)
            { question: 'Ao avaliar informaÃ§Ãµes sobre dietas e saÃºde, qual Ã© um sinal de alerta que indica que uma dieta pode ser duvidosa?', options: ['Promessas de resultados rÃ¡pidos e "milagrosos" sem esforÃ§o', 'Baseada em estudos cientÃ­ficos controlados', 'RecomendaÃ§Ã£o de consumir alimentos variados', 'Foco em mudanÃ§as graduais e sustentÃ¡veis', 'OrientaÃ§Ã£o para buscar profissionais qualificados'], answer: 'Promessas de resultados rÃ¡pidos e "milagrosos" sem esforÃ§o', explanation: 'Dietas que prometem perda de peso muito rÃ¡pida, "curas" para vÃ¡rias condiÃ§Ãµes ou resultados sem qualquer esforÃ§o sÃ£o geralmente irrealistas e podem ser prejudiciais.', points: 40 }
        ];

        // --- FUNÃ‡Ã•ES GERAIS E DE TELA ---
        function showScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');
        }

        function toggleButtonLoader(button, show) {
            const buttonText = button.querySelector('.button-text');
            const loader = button.querySelector('.loader');
            if (buttonText && loader) {
                buttonText.style.display = show ? 'none' : 'inline';
                loader.style.display = show ? 'inline-block' : 'none';
            }
            button.disabled = show;
        }

        async function callAppsScript(action, data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify({ action, ...data })
                });
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                return await response.json();
            } catch (error) {
                console.error("Erro ao contatar o Apps Script:", error);
                return { status: 'error', message: 'Falha de comunicaÃ§Ã£o. Verifique a publicaÃ§Ã£o do script e sua conexÃ£o.' };
            }
        }
        
        function capitalizeName(name) {
            return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function handleSuccessfulLogin(userData) {
            const firstName = userData.name.split(' ')[0];
            loggedInUser = { ...userData, firstName };
            sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            playerFirstNameEl.textContent = firstName;
            showScreen(videoScreen);
        }

        // --- LÃ“GICA DE LOGIN E CADASTRO ---
        loginButton.addEventListener('click', async () => {
            const code = loginCodeInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginMessage.textContent = '';
            if (!code || !password) {
                loginMessage.textContent = 'Preencha o cÃ³digo e a senha.';
                return;
            }
            toggleButtonLoader(loginButton, true);
            const result = await callAppsScript('login', { code, password });
            toggleButtonLoader(loginButton, false);
            if (result.status === 'success') {
                handleSuccessfulLogin({ name: result.name, code: code, turma: result.turma });
            } else if (result.status === 'not_found') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                registerCodeInput.value = code;
                registerCodeInput.removeAttribute('readonly');
            } else {
                loginMessage.textContent = result.message || 'Ocorreu um erro.';
            }
        });
        
        goToRegisterButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            loginMessage.textContent = '';
            registerCodeInput.removeAttribute('readonly');
            registerCodeInput.value = '';
        });

        registerButton.addEventListener('click', async () => {
            const rawName = registerNameInput.value.trim();
            const turma = registerClassInput.value;
            const code = registerCodeInput.value.trim();
            const password = registerPasswordInput.value.trim();
            registerMessage.textContent = '';
            if (!rawName || !turma || !code || !password) {
                registerMessage.textContent = 'Todos os campos sÃ£o obrigatÃ³rios.';
                return;
            }
            const name = capitalizeName(rawName);
            toggleButtonLoader(registerButton, true);
            const data = { name, turma, code, password };
            const result = await callAppsScript('register', data);
            toggleButtonLoader(registerButton, false);
            if (result.status === 'success') {
                handleSuccessfulLogin({ name: name, code: code, turma: turma });
            } else {
                registerMessage.textContent = result.message || 'Ocorreu um erro.';
            }
        });

        backToLoginButton.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            registerMessage.textContent = '';
        });

        loginPasswordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loginButton.click(); });
        loginCodeInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loginButton.click(); });
        registerPasswordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });
        registerCodeInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });
        registerNameInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });

        window.addEventListener('load', () => {
            const user = sessionStorage.getItem('loggedInUser');
            if (user) {
                loggedInUser = JSON.parse(user);
                playerFirstNameEl.textContent = loggedInUser.firstName;
                showScreen(videoScreen);
            } else {
                showScreen(loginScreen);
            }
            updateScoreDisplay();
        });
        
        // --- LÃ“GICA DO VÃDEO ---
        let player;
        let progressCheckInterval;
        let maxWatchedTime = 0;

        function updateScoreDisplay() {
            document.querySelectorAll('.score-display').forEach(el => el.textContent = score);
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'k0W2mmr4oEQ',
                playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady(event) {
            maxWatchedTime = 0;
            videoPointsInvalidated = false;
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                clearInterval(progressCheckInterval); 
                progressCheckInterval = setInterval(() => {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    const isMuted = player.isMuted();
                    const playbackRate = player.getPlaybackRate();
                    const scoreTextEl = videoScreen.querySelector('.score-display').parentElement;

                    if (currentTime > maxWatchedTime + 1.5) {
                        player.seekTo(maxWatchedTime, true);
                    } else if (currentTime > maxWatchedTime) {
                        maxWatchedTime = currentTime;
                    }
                    
                    if (isMuted || playbackRate !== 1) {
                        videoPointsInvalidated = true;
                    }

                    if(videoPointsInvalidated) {
                        score = 0;
                        scoreTextEl.classList.add('text-red-500');
                    } else if (duration > 0) {
                        const potentialScore = (maxWatchedTime / duration) * 1000;
                        score = Math.floor(potentialScore / 10) * 10;
                        scoreTextEl.classList.remove('text-red-500');
                    }
                    updateScoreDisplay();

                    if ((maxWatchedTime / duration) >= 0.9) {
                        if (continueBtn.disabled) {
                            continueBtn.disabled = false;
                            continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }, 500);
            } else {
                clearInterval(progressCheckInterval);
            }
        }

        continueBtn.addEventListener('click', () => {
            if (!continueBtn.disabled) {
                showScreen(gameScreen);
                startGame();
            }
        });

        skipVideoBtn.addEventListener('click', () => {
            score = 0;
            updateScoreDisplay();
            showScreen(gameScreen);
            startGame();
        });

        // --- LÃ“GICA DO QUIZ ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            if(player && typeof player.stopVideo === 'function') {
                player.stopVideo();
            }
            currentQuestionIndex = 0;
            shuffledQuestions = shuffleArray([...questions]);
            startTime = new Date();
            updateScoreDisplay();
            displayNextQuestion();
        }

        function displayNextQuestion() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                endGame(true); // Finaliza o jogo se todas as questÃµes foram respondidas
                return;
            }

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            questionContainer.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';

            const shuffledOptions = shuffleArray([...currentQuestion.options]);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button', 'w-full', 'bg-white/10', 'text-white', 'text-lg', 'sm:text-xl', 'font-bold', 'py-4', 'px-2', 'rounded-xl', 'shadow-lg', 'border-violet-400', 'hover:bg-violet-500/30');
                button.addEventListener('click', handleAnswer);
                optionsContainer.appendChild(button);
            });
        }

        function handleAnswer(e) {
            const selectedOption = e.target.textContent;
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer;
            const explanation = currentQuestion.explanation;

            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                score += currentQuestion.points;
                showFeedback(`+${currentQuestion.points} Pontos! ðŸŽ‰`, explanation, true);
                e.target.classList.remove('bg-white/10', 'border-violet-400', 'hover:bg-violet-500/30');
                e.target.classList.add('bg-green-500', 'border-green-700', 'text-white');
            } else {
                const wrongFeedbackMsg = `Ops! A resposta certa Ã© "${correctAnswer}".`;
                showFeedback(wrongFeedbackMsg, explanation, false);
                 e.target.classList.remove('bg-white/10', 'border-violet-400', 'hover:bg-violet-500/30');
                e.target.classList.add('bg-red-500', 'border-red-700', 'text-white');
            }
            
            updateScoreDisplay();
            currentQuestionIndex++;
        }

        function showFeedback(message, explanation, isCorrect) {
            feedbackEl.innerHTML = `
                <strong class="block text-3xl mb-2">${message}</strong>
                <span class="text-xl mt-2 block font-normal">${explanation}</span>
                <button id="feedback-continue-btn" class="mt-6 w-full bg-white/20 text-white font-bold py-3 rounded-xl hover:bg-white/30 transition option-button border-white/30">Continuar â†’</button>
            `;
            
            const colorClass = isCorrect ? 'bg-gradient-to-br from-green-400 to-emerald-600' : 'bg-gradient-to-br from-red-400 to-rose-600';
            feedbackEl.className = `fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 sm:p-8 rounded-2xl text-white text-2xl font-bold shadow-2xl w-11/12 max-w-sm text-center transition-all duration-300 ease-in-out ${colorClass} opacity-0 scale-90`;
            
            feedbackEl.classList.remove('pointer-events-none');
            
            requestAnimationFrame(() => {
                feedbackEl.classList.remove('opacity-0', 'scale-90');
            });

            const hideAndContinue = () => {
                feedbackEl.classList.add('opacity-0', 'scale-90', 'pointer-events-none');
                setTimeout(displayNextQuestion, 300); // Wait for animation
            };

            document.getElementById('feedback-continue-btn').addEventListener('click', hideAndContinue, { once: true });
        }
        
        function getMotivationalMessage(finalScore) {
            if (finalScore >= 1000) {
                return "Excelente, " + loggedInUser.firstName + "! VocÃª domina a ciÃªncia! ðŸ†";
            } else if (finalScore >= 500) {
                return "Muito bem, " + loggedInUser.firstName + "! Continue praticando para ficar ainda melhor. ðŸ‘";
            } else {
                return "NÃ£o desista, " + loggedInUser.firstName + "! Cada tentativa Ã© um passo para aprender mais. âœ¨";
            }
        }
        
        // --- LÃ“GICA DE FIM DE JOGO E RANKING ---
        function resetGame() {
            score = 0;
            currentQuestionIndex = 0;
            videoPointsInvalidated = false;
            maxWatchedTime = 0;
            startTime = null;

            updateScoreDisplay();
            
            if (player && typeof player.seekTo === 'function') {
                player.seekTo(0, true);
                player.stopVideo();
            }
            
            continueBtn.disabled = true;
            continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
            videoScreen.querySelector('.score-display').parentElement.classList.remove('text-red-500');

            showScreen(videoScreen);
        }

        async function endGame(allQuestionsAnswered = false) {
            let finalScore = score;
            bonusMessageEl.textContent = '';
            
            if (allQuestionsAnswered){
                 finalScore += 500; // BÃ´nus por terminar todas as questÃµes
                 bonusMessageEl.textContent = `+500 pontos de bÃ´nus por terminar o jogo!`;
            }

            const endTime = new Date();
            const timeSpent = Math.round((endTime - startTime) / 1000);
            
            showScreen(endScreen);
            endScreenContent.classList.remove('hidden');
            playAgainButton.classList.remove('hidden');
            backFromRankingButton.classList.add('hidden');
            document.getElementById('final-score').textContent = finalScore;
            finalMessageEl.textContent = getMotivationalMessage(finalScore);
            
            const result = await callAppsScript('saveScoreAndGetRanking', { 
                fullName: loggedInUser.name, 
                turma: loggedInUser.turma, 
                score: finalScore, 
                time: timeSpent,
                nomeDoJogo: NOME_DESTE_JOGO,
                code: loggedInUser.code
            });
            
            if (result.status === 'success') {
                populateRankingTable(result.ranking, loggedInUser.code);
            } else {
                document.getElementById('ranking-body').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">${result.message}</td></tr>`;
            }
        }
        
        async function displayRanking() {
            showScreen(endScreen);
            endScreenContent.classList.add('hidden');
            playAgainButton.classList.add('hidden');
            backFromRankingButton.classList.remove('hidden');

            const result = await callAppsScript('getRanking', { nomeDoJogo: NOME_DESTE_JOGO });
            if (result.status === 'success') {
                const userCode = loggedInUser ? loggedInUser.code : null;
                populateRankingTable(result.ranking, userCode);
            } else {
                document.getElementById('ranking-body').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">${result.message}</td></tr>`;
            }
        }

        viewRankingButton.addEventListener('click', displayRanking);
        
        backFromRankingButton.addEventListener('click', () => {
            showScreen(loginScreen);
        });

        function populateRankingTable(ranking, currentUserCode) {
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = '';
            if(!ranking || ranking.length === 0){
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Ainda nÃ£o hÃ¡ pontuaÃ§Ãµes. Seja o primeiro!</td></tr>`;
                return;
            }
            ranking.forEach((entry, index) => {
                const isCurrentUser = currentUserCode && entry.code === currentUserCode;
                const row = `
                    <tr class="border-b border-white/10 ${isCurrentUser ? 'bg-yellow-500/30' : ''}">
                        <td class="p-2 font-bold">${index + 1}</td>
                        <td class="p-2">${entry.name}</td>
                        <td class="p-2">${entry.score}</td>
                        <td class="p-2">${entry.turma}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        playAgainButton.addEventListener('click', resetGame);

    </script>
</body>
</html>

